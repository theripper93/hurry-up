(()=>{"use strict";var e={d:(t,i)=>{for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{D:()=>n});class Socket{static __$callbacks={};static __$stores={};static __$promises={};static USERS={GMS:"gms",PLAYERS:"players",ALL:"all",OTHERS:"others",FIRSTGM:"firstGM",SELF:"self"};static __$reserved=["__$eventName","__$response","__$onMessage","__$parseUsers","register","USERS"];static async __$onMessage(e){const t=e.__$socketOptions;if(t.__$storeName){if(t.__$request){const e=this.__$stores[t.__$storeName];if(!e._isLive)return;game.socket.emit(`module.${n}`,{__$socketOptions:{__$storeName:t.__$storeName,user:game.user.id},data:e.getData()})}else this.__$stores[t.__$storeName].synchronize(e.data,game.users.get(t.user));return}if("__$response"===t.__$eventName){const i=t.__$responseKey;return void(this.__$promises[i]&&(this.__$promises[i].resolve({user:game.users.get(t.__$userId),response:e.result}),delete this.__$promises[i]))}if(!t.users.includes(game.user.id))return;const i=this.__$callbacks[t.__$eventName];delete e.__$socketOptions;const s=await i(e);if(t.response){const e={__$socketOptions:{__$eventName:"__$response",__$responseKey:`${t.__$eventId}.${game.user.id}`,__$userId:game.user.id},result:s};this.__$socket.emit(`module.${n}`,e)}}static __$parseUsers(e){if(Array.isArray(e?.users))return e;"string"==typeof e&&(e={users:e}),Array.isArray(e)&&(e={users:e}),e.users=e.users||this.USERS.ALL;const t=game.users.filter(e=>e.active),i=e.users;return i===this.USERS.ALL?e.users=t.map(e=>e.id):i===this.USERS.GMS?e.users=t.filter(e=>e.isGM).map(e=>e.id):i===this.USERS.PLAYERS?e.users=t.filter(e=>!e.isGM).map(e=>e.id):i===this.USERS.OTHERS?e.users=t.filter(e=>e.id!==game.user.id).map(e=>e.id):i===this.USERS.FIRSTGM?e.users=[game.users.activeGM.id]:i===this.USERS.SELF&&(e.users=[game.user.id]),e}static register(e,t,i={}){if(this.__$socket||(this.__$socket=game.socket,game.socket.on(`module.${n}`,this.__$onMessage.bind(this))),this.__$reserved.includes(e))throw new Error(`Socket event name ${e} is reserved`);this.__$callbacks[e]=t;this[e]=(async(s={},a={})=>{a={...i,...a},a=this.__$parseUsers(a);const r=foundry.utils.randomID();a.__$eventId=r,a.__$eventName=e;const o=[],u=a.users.includes(game.user.id);if(a.users=a.users.filter(e=>e!==game.user.id),a.response){for(const e of a.users)o.push(new Promise((t,i)=>{const s=`${r}.${e}`;this.__$promises[s]={resolve:t,reject:i}}));setTimeout(()=>{for(const e of a.users){const t=`${r}.${e}`;this.__$promises[t]&&(this.__$promises[t].reject({user:game.users.get(e),response:"timeout"}),delete this.__$promises[t])}},a.timeout||3e4)}s.__$socketOptions=a,this.__$socket.emit(`module.${n}`,s);const h=[];if(u){const localWrapper=async()=>({user:game.user,response:await t(s)});o.push(localWrapper())}const d=await Promise.all(o);for(const e of d)h.push(e);return h}).bind(this)}static registerStore(e,t={},i=null){if(this.__$reserved.includes(e))throw new Error(`Store name ${e} is reserved`);if("object"!=typeof t)throw new Error("Initial value for store must be an object");return this.__$stores[e]=new SynchronizedStore(e,t,i),Object.defineProperty(this,e,{get:()=>this.__$stores[e].getData(),set:t=>{this.__$stores[e].setData(t)}}),this.__$stores[e]}}class SynchronizedStore{constructor(e,t,i){this._storeName=e,this._onChange=i,this._data=t,this._timestamp=Date.now(),this._isLive=!1,game.socket.emit(`module.${n}`,{__$socketOptions:{__$storeName:this._storeName,__$request:!0,user:game.user.id}})}synchronize(e){this._data=e,this._timestamp=Date.now(),this._isLive=!0,this._onChange?.(this.data)}getData(){return this._data}setData(e){this.synchronize(e),game.socket.emit(`module.${n}`,{__$socketOptions:{__$storeName:this._storeName,user:game.user.id},data:e})}}class HandlebarsApplication extends(foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2)){constructor(...e){super(...e),this.constructor.registerPositionSetting(),this.savePosition=foundry.utils.debounce(this.savePosition.bind(this),100)}static registerPositionSetting(){!this.POSITION_SETTING_REGISTERED&&this.DEFAULT_OPTIONS.window?.savePosition&&(this.POSITION_SETTING_REGISTERED=!0,game.settings.register(n,this.APP_ID+"-position",{scope:"client",config:!1,type:Object,default:{}}))}static resetSavedPosition(){game.settings.set(n,this.APP_ID+"-position",{})}savePosition(e){const t={left:e.left,top:e.top,width:e.width,height:e.height};"auto"===t.width&&delete t.width,"auto"===t.height&&delete t.height;const i=game.settings.get(n,this.APP_ID+"-position");game.settings.set(n,this.APP_ID+"-position",{...i,[this.options.id]:t})}deletePosition(){const e=game.settings.get(n,this.APP_ID+"-position");delete e[this.options.id],game.settings.set(n,this.APP_ID+"-position",e)}setPosition(...e){const t=super.setPosition(...e);return this.constructor.POSITION_SETTING_REGISTERED&&this.options.window?.savePosition&&this.savePosition(this.position),t}static get APP_ID(){return this.name.split(/(?=[A-Z])/).join("-").toLowerCase()}get APP_ID(){return this.constructor.APP_ID}static get PARTS(){return{content:{template:`modules/${n}/templates/${this.APP_ID}.hbs`,classes:[],scrollable:[]}}}static get DEFAULT_OPTIONS(){return{tag:"div",window:{title:`${n}.${this.APP_ID}.title`,frame:!0,positioned:!0,icon:"",controls:[],minimizable:!0,resizable:!1,contentTag:"section",contentClasses:[],savePosition:!1,preventEscapeClose:!1},actions:{},form:{handler:void 0,submitOnChange:!1,closeOnSubmit:!1},position:{width:560,height:"auto"}}}async _prepareContext(e){if(this.getData)return this.getData();return{data:{}}}activateListeners(){}_onRender(e,t){super._onRender(e,t),this.options.window.preventEscapeClose&&(foundry.applications.instances.delete(this.id,this),this.window.close.style.display="none");const i=this.element;this.activateListeners&&this.activateListeners(i)}async render(e={},t={}){const i="boolean"==typeof e?t:e;if(!i.position&&this.constructor.POSITION_SETTING_REGISTERED){const e=game.settings.get(n,this.APP_ID+"-position");i.position=e?.[this.options.id]}return super.render(e,t)}}function l(e){return game.i18n.localize(e)}class CombatTimer extends HandlebarsApplication{static timerInstances={};constructor(e){const t=game.settings.get("hurry-up","timersData")[e],i={};t.isSecondary&&(i.position={top:window.innerHeight/2,left:window.innerWidth/2},i.id=e,t.name&&(i.classes=["named"],i.window={title:t.name})),super(i),this.mainName=l("COMBAT.Turn"),this.started=!1,this.sleepTimer=void 0,this.setupTimer(!1),this.sandFrame=0,CombatTimer.timerInstances[this.options.id]=this,this.startTimer()}setupColors(){this.color||=getComputedStyle(this.element).color,this.glassColor=getComputedStyle(this.element).color,this.criticalColor="rgba(255, 0, 0, 0.75)",this.barCriticalColor="rgb(255, 0, 0)"}setupTimer(e=!1){const t=(game.settings.get("hurry-up","timersData")??{})[this.options.id];if(this.timeNow=game.time.serverTime,this.name=t.name,this.isSecondary=t.isSecondary,this.time=t.time??game.settings.get("hurry-up","timerDuration"),this.color=t.color,this.style=t.style??game.settings.get("hurry-up","style")??"digits",this.countup=game.settings.get("hurry-up","countup"),t.startedAt){this.startedAt=t.startedAt,this.manuallyPaused=t.manuallyPaused??!1,this.pausedAt=t.pausedAt??this.timeNow,this.pausedFor=t.pausedFor??0;game?.paused||this.manuallyPaused?(this.pausedFor=this.pausedFor+game.time.serverTime-this.pausedAt,this.pausedAt=this.timeNow,this.timeElapsed=this.pausedAt-this.startedAt-this.pausedFor):this.timeElapsed=this.timeNow-this.startedAt-this.pausedFor,this.timeRemaining=this.time-Math.floor(this.timeElapsed/1e3),this.timeRemaining=Math.max(this.timeRemaining,0)}else this.startedAt=this.timeNow,this.manuallyPaused=!1,this.pausedAt=this.isPaused()?this.timeNow:void 0,this.pausedFor=0,this.timeElapsed=0,this.timeRemaining=this.time;this.hasEnded=this.timeRemaining<=0,e&&this.render()}static reset(e){const t=game.settings.get("hurry-up","timersData")??{},i=t[e];i.startedAt=game.time.serverTime,i.pausedAt=void 0;(game?.paused||i.manuallyPaused)&&(i.pausedAt=game.time.serverTime),i.pausedFor=0,game.settings.set("hurry-up","timersData",t)}static async setPause(e,t,i=!0){const s=game.settings.get("hurry-up","timersData")??{},a=s[e];i&&(a.manuallyPaused=t);const n=game?.paused||a.manuallyPaused,r=n&&!a.pausedAt,o=!n&&!!a.pausedAt;r&&(a.pausedAt=game.time.serverTime),o&&(a.pausedFor=a.pausedFor+game.time.serverTime-a.pausedAt,a.pausedAt=void 0),await game.settings.set("hurry-up","timersData",s)}isPaused(){return game?.paused||this.manuallyPaused}isManuallyPaused(){return this.manuallyPaused}isSecondaryTimer(){return this.isSecondary}_configureRenderParts(...e){const t=super._configureRenderParts(...e);let i;switch(this.style){case"digits":i="modules/hurry-up/templates/hurry-up-digits.hbs";break;case"circle":case"sand":i="modules/hurry-up/templates/hurry-up-canvas.hbs"}return t.content.template=i,t}static get DEFAULT_OPTIONS(){return function mergeClone(e,t){return e=foundry.utils.deepClone(e),t=foundry.utils.deepClone(t),foundry.utils.mergeObject(e,t)}(super.DEFAULT_OPTIONS,{tag:"div",id:"hurry-up",classes:["hurry-up"],window:{title:"",minimizable:!0,resizable:!1,preventEscapeClose:!0,savePosition:!0},position:{width:"auto",height:"auto"}})}static get PARTS(){return{content:{template:""}}}startTimer(e=!1){e&&CombatTimer.reset(this.options.id),this.started=!0,this.sleepTimer=setInterval(this.updateTime.bind(this),100)}async onEnd(){this.endSound(),game.settings.get("hurry-up","goNext")&&game.user.isGM&&!this.isSecondary&&game.combat?.nextTurn()}async sleep(e){return new Promise(t=>this.sleepTimer=setTimeout(t,e))}async endSound(){this.critSound?.stop();const e=game.settings.get("hurry-up","endSoundPath");e&&foundry.audio.AudioHelper.play({src:e,autoplay:!0,volume:game.settings.get("hurry-up","soundVol"),loop:!1},!1)}updateVisuals(){switch(this.style){case"digits":this.updateDigits();break;case"circle":this.updateCircle();break;case"sand":this.updateSand()}}updateTime(e=!1){if(this.element&&(this.isPaused()?this.critSound?.playing&&this.critSound?.pause():(this.timeNow=game.time.serverTime,this.timeElapsed=this.timeNow-this.startedAt-this.pausedFor,this.timeRemaining=this.time-Math.floor(this.timeElapsed/1e3),this.timeRemaining=Math.max(this.timeRemaining,0)),!this.isPaused()||e)){this.updateVisuals(),this.checkCritical(),this.timeRemaining<=0&&!this.hasEnded&&(this.onEnd(),this.hasEnded=!0);const e=this.isSecondary?this.name:this.mainName;this.minimized||"digits"!==this.style?this._updateFrame({window:{title:`${e?e+" - ":""}${this.getFormattedTime()}`}}):this._updateFrame({window:{title:e}})}}getFormattedTime(){const e=this.countup?this.timeElapsed/1e3:this.timeRemaining,t=Math.floor(e/3600),i=Math.floor(e%3600/60),s=Math.floor(e%60);return`${t>0?`${t}`.padStart(2,"0")+":":""}${`${i}`.padStart(2,"0")}:${`${s}`.padStart(2,"0")}`}updateDigits(){if(!this.element)return;this.element.querySelector(".hurry-up-timer-text").textContent=this.getFormattedTime();let e=Math.min(Math.max(this.timeRemaining/this.time*100,0),100);this.countup&&(e=100-e),this.element.querySelector(".hurry-up-bar").style.width=`${e}%`}updateCircle(){if(!this.element)return;const e=360*Math.min(Math.max(this.timeElapsed/(1e3*this.time),0),1),t=20*game.settings.get("hurry-up","size"),i=t/2,s=i-5,a=this.element.querySelector(".hurry-up-canvas");a.setAttribute("height",t),a.setAttribute("width",t);const n=a.getContext("2d"),r=(e/360*2-.5)*Math.PI,o=1.5*Math.PI;n.clearRect(0,0,t,t),n.fillStyle=this.glassColor,n.moveTo(i,i),n.beginPath(),n.arc(i,i,s,0,2*Math.PI),n.globalAlpha=.2,n.lineWidth=1,n.strokeStyle=this.glassColor,n.stroke(),n.globalAlpha=.1,n.fill(),n.globalAlpha=1,n.closePath(),n.beginPath(),n.fillStyle=this.isCritical||this.timeRemaining<=0?this.criticalColor:this.color,n.moveTo(i,i),this.timeRemaining>0?game.settings.get("hurry-up","countup")?n.arc(i,i,s,o,r):n.arc(i,i,s,r,o):game.settings.get("hurry-up","countup")&&n.arc(i,i,s,0,2*Math.PI),n.shadowOffsetX=2,n.shadowOffsetY=2,n.shadowColor="rgba(0, 0, 0, 0.75)",n.shadowBlur=2,n.fill(),n.closePath()}updateSand(){if(!this.element)return;const e=20*game.settings.get("hurry-up","size"),t=2*e,i=t/2,s=e/2,a=.025*t>5?5:Math.round(.025*t),n=2*a,r=t/10*3,o=r*Math.min(Math.max(this.timeElapsed/(1e3*this.time),0),1),u=this.element.querySelector(".hurry-up-canvas"),h=u.getContext("2d");u.setAttribute("height",t),u.setAttribute("width",e),u.style.width=e+"px",this.element.querySelector(".window-header").style.width=e,h.restore(),h.clearRect(0,0,e,t),h.shadowOffsetX=2,h.shadowOffsetY=2,h.shadowColor="rgba(0, 0, 0, 1)",h.shadowBlur=2,h.beginPath(),h.moveTo(s,a),h.bezierCurveTo(e/10*9-a,a,e-a,t/10,e-a,t/10*2),h.quadraticCurveTo(e-a,t/10*3,e/20*11,i),h.quadraticCurveTo(e-a,t/10*7,e-a,t/10*8),h.bezierCurveTo(e-a,t/10*9,e/10*9-a,t-a,s,t-a),h.bezierCurveTo(e/10+a,t-a,a,t/10*9,a,t/10*8),h.quadraticCurveTo(a,t/10*7,e/20*9,i),h.quadraticCurveTo(a,t/10*3,a,t/10*2),h.bezierCurveTo(a,t/10,e/10+a,a,s,a),h.globalAlpha=.2,h.lineWidth=1,h.strokeStyle=this.glassColor,h.stroke(),h.fillStyle=this.glassColor,h.globalAlpha=.1,h.fill(),h.globalAlpha=1,h.closePath(),h.save(),h.beginPath(),h.shadowColor="rgba(0, 0, 0, 0)",h.moveTo(s,n),h.bezierCurveTo(e/4*3-n,n,e-n,t/10,e-n,t/10*2),h.quadraticCurveTo(e-n,t/10*3,s,i),h.quadraticCurveTo(e-n,t/10*7,e-n,t/10*8),h.bezierCurveTo(e-n,t/10*9,e/10*9-n,t-n,s,t-n),h.bezierCurveTo(e/10+n,t-n,n,t/10*9,n,t/10*8),h.quadraticCurveTo(n,t/10*7,s,i),h.quadraticCurveTo(n,t/10*3,n,t/10*2),h.bezierCurveTo(n,t/10,e/4+n,n,e/2,n),h.clip(),h.beginPath(),h.shadowColor="rgba(0, 0, 0, 0)",h.moveTo(0,t/10*2+o),h.lineTo(e,t/10*2+o),h.lineTo(e,i),h.lineTo(0,i),h.lineTo(0,0),h.fillStyle=this.isCritical?this.criticalColor:this.color,h.fill(),h.closePath(),h.beginPath(),h.moveTo(0,t-n-o),h.lineTo(e,t-n-o),h.lineTo(e,t),h.lineTo(0,t),h.lineTo(0,t-n-o),h.fillStyle=this.isCritical||this.timeRemaining<0?this.criticalColor:this.color,h.fill(),h.closePath(),o<r&&(h.beginPath(),this.sandFrame%2==0?h.lineDashOffset=0:h.lineDashOffset=2,h.setLineDash([2,2]),h.lineWidth=1,h.lineCap="round",h.moveTo(s,i),h.lineTo(s,t-n-o),h.strokeStyle=this.isCritical?this.criticalColor:this.color,h.stroke(),h.closePath(),this.sandFrame++)}updateWindowless(){const e=this.element.querySelector(".window-header");e&&(game.settings.get("hurry-up","windowless")?e.classList.add("windowless"):e.classList.remove("windowless"))}checkCritical(){if(this.timeRemaining<=0)return this.onCriticalEnd(),void this.setCriticalStyle();if(!this.isCritical){if(this.hasEnded)return;if(game.settings.get("hurry-up","secondsInsteadOfPercentage"))this.timeRemaining<=game.settings.get("hurry-up","critical")&&(this.isCritical=!0);else{this.timeRemaining/this.time*100<=game.settings.get("hurry-up","critical")&&(this.isCritical=!0)}this.timeRemaining<=2&&(this.isCritical=!0),this.isCritical&&(this.onCritical(),this.setCriticalStyle())}}setCriticalStyle(){if(this.isCritical)switch(this.style){case"digits":this.element.querySelector(".hurry-up-bar").style.backgroundColor=this.barCriticalColor,this.element.querySelector(".hurry-up-timer-text").classList.add("blinking");break;case"circle":this.element.querySelector(".hurry-up-canvas").classList.add("blinking")}else switch(this.style){case"digits":this.element.querySelector(".hurry-up-bar").style.backgroundColor=this.color,this.element.querySelector(".hurry-up-timer-text").classList.remove("blinking");break;case"circle":this.element.querySelector(".hurry-up-canvas").classList.remove("blinking")}}async onCritical(){this.critSound?.stop();const e=game.settings.get("hurry-up","critSoundPath");e&&(this.critSound=await foundry.audio.AudioHelper.play({src:e,autoplay:!0,volume:game.settings.get("hurry-up","soundVol"),loop:!0},!1))}async onCriticalEnd(){this.isCritical=!1,this.critSound?.stop()}async minimize(){super.minimize(),this.updateTime(!0)}async maximize(){super.maximize(),this.updateTime(!0)}_onRender(e,t){super._onRender(e,t),this.isCritical=!1,this.updateTime(!0),this.checkCritical();const i=game.settings.get("hurry-up","countup");switch(this.setupColors(),this.style){case"digits":this.element.querySelector(".hurry-up-bar").style.backgroundColor=this.color,this.element.querySelector(".hurry-up-bar").style.width=i,this.element.querySelector(".hurry-up-timer-text").classList.remove("blinking");break;case"circle":case"sand":this.element.querySelector(".hurry-up-canvas").classList.remove("blinking")}document.documentElement.style.setProperty("--hurry-up-font-size",game.settings.get("hurry-up","size")+"em"),this.updateWindowless(),this.setCriticalStyle(),this.manuallyPaused?this.element.classList.add("paused"):this.element.classList.remove("paused")}_onFirstRender(...e){super._onFirstRender(...e),game.user.isGM&&new foundry.applications.ux.ContextMenu(this.element,".window-content, .window-header",[{condition:()=>this.isManuallyPaused(),name:"hp.contextMenu.unpause",icon:'<i class="fas fa-play"></i>',callback:()=>CombatTimer.setPause(this.options.id,!1)},{condition:()=>!this.isManuallyPaused(),name:"hp.contextMenu.pause",icon:'<i class="fas fa-pause"></i>',callback:()=>CombatTimer.setPause(this.options.id,!0)},{name:"hp.contextMenu.reset",icon:'<i class="fas fa-arrow-rotate-right"></i>',callback:()=>this.startTimer(!0)},{condition:!!this.isSecondary,name:"hp.contextMenu.close",icon:'<i class="fas fa-close"></i>',callback:()=>{CombatTimer.deleteTimer(this.options.id)}}],{jQuery:!1,fixed:!0})}_prepareContext(...e){return{}}setPosition(...e){super.setPosition(...e),this.element.style.width="auto",this.element.style.height="auto"}_onClose(...e){return clearInterval(this.sleepTimer),this.started=!1,this.critSound?.stop(),game.combatTimer=null,!this.name&&this.isSecondary&&this.deletePosition(),delete CombatTimer.timerInstances[this.options.id],super._onClose(...e)}renderTemplate(){this.render(!0),this.updateTime(!0)}static start(e={}){if(e.isSecondary){const t=new CombatTimer(e);t.render({force:!0}),t.startTimer()}else game.combatTimer||(game.combatTimer=new CombatTimer(e)),game.combatTimer.rendered||game.combatTimer.render({force:!0}),game.combatTimer.startTimer()}static socketTimer({time:e,name:t}){CombatTimer.start({time:e,name:t,isSecondary:!0})}static async createTimer(e,{name:t="",isSecondary:i=!0,color:s=null,paused:a=!1,style:n=null}={}){e=Number.isFinite(e)?e:game.settings.get("hurry-up","timerDuration");const r=game.settings.get("hurry-up","timersData")??{};let o;if(i){if(o=t?`hurry-up-${t.slugify({strict:!0})}`:`hurry-up-${function randomID(e=20){return foundry.utils.randomID(e)}(10)}`,o in r)return ui.notifications.error(`Timer with name ${t} already exists`)}else if(o="hurry-up",o in r)return this.reset(o);return r[o]={id:o,isSecondary:i,name:t,time:e,startedAt:game.time.serverTime,pausedAt:a||game?.paused?game.time.serverTime:void 0,pausedFor:0,manuallyPaused:a,color:s,style:n},await game.settings.set("hurry-up","timersData",r),r}static async deleteTimer(e){const t=game.settings.get("hurry-up","timersData")??{};return delete t[e],await game.settings.set("hurry-up","timersData",t)}static async checkAndCreateMainTimer(){if(game.settings.get("hurry-up","disable"))return CombatTimer.deleteTimer("hurry-up");const e=canvas.tokens.get(game?.combat?.current?.tokenId),t=e?.actor;game.settings.get("hurry-up","runForNPC")||t?.hasPlayerOwner?CombatTimer.createTimer(void 0,{isSecondary:!1}):CombatTimer.deleteTimer("hurry-up")}static updateAndSync(){const e=game.settings.get("hurry-up","timersData")??{};for(const t of Object.values(e)){const e=CombatTimer.timerInstances[t.id];e?e.setupTimer(!0):new CombatTimer(t.id).render({force:!0})}for(const t of Object.values(CombatTimer.timerInstances))e[t.options.id]||t.close()}static unFuckSetting(e=!1){return e||game.settings.get("hurry-up","timersData")instanceof Boolean?game.settings.set("hurry-up","timersData",{}):void 0}}const t="6uy8g1tXqHlhlp65dhiL-genericFormHelper-hurry-up";class FormBuilder{constructor(){this.submitButton()}#e=[];#t=[];#i=[];#s={position:{width:560,height:"auto"},window:{}};#a=null;#n=null;#r=null;#o=null;get app(){return this.#o}async render(){const e=this.form();return e.render(!0),e.promise}form(){if(this.#o)return this.#o;const e=new FormHelper({tabs:this.#e,fields:this.#t,buttons:this.#i,options:this.#s});return this.#o=e,e}getHTML(){const e=this.form()._prepareContext();return FormHelper.registerPartial(),renderTemplate(t,e)}getAsClass(e){const t={...e,tabs:this.#e,fields:this.#t,buttons:this.#i,options:this.#s};return class extends FormHelper{constructor(e={}){super({...t,...e})}}}onRender(e){return this.#s.onRender=e,this}registerAsMenu({moduleId:e,key:t,name:i,label:s,icon:a,hint:r,scope:o,restricted:u,defaultValue:h,onChange:d,requiresReload:m}={}){e??=n,o??="world",u??=!0,h??={},t??="settings",a??="fas fa-cogs",s??="Configure",i??="Configuration Menu",r??="Configure the module settings";const c={settingsMenu:{requiresReload:m,onChange:d,moduleId:e,key:t}},p=this.getAsClass(c);return game.settings.registerMenu(e,t+"-menu",{name:i,label:s,hint:r,icon:a,scope:o,restricted:u,type:p}),game.settings.register(e,t,{scope:o,config:!1,default:h,type:Object,onChange:d,requiresReload:m}),{getSetting:()=>game.settings.get(e,t),setSetting:i=>game.settings.set(e,t,i)}}async insertHTML(e,t,i="afterend"){const s=await this.getHTML(),a=document.createElement("div");a.innerHTML=s;const n=a.children[0],r=t?e.querySelector(t):e;if(!r)throw new Error(`Element ${t} not found`);return r.insertAdjacentElement(i,n),n}#l(e){if(this.#r&&e.name){const t=foundry.utils.getProperty(this.#r,e.name);void 0!==t&&(e.value=t)}return this.#n?this.#n.fields.push(e):this.#a?this.#a.fields.push(e):this.#t.push(e)}title(e){return this.#s.window.title=e,this}resizable(e=!0){return this.#s.window.resizable=e,this}info(e){return this.#s.info=e,this}object(e){return this.#r=e,this}size({width:e,height:t}){return this.#s.position={width:e??560,height:t??"auto"},this}submitButton({enabled:e=!0,label:t="Confirm",icon:i="fa-solid fa-check"}={}){const s={type:"submit",action:"submit",icon:i,label:t};return e?this.#i.push(s):this.#i=this.#i.filter(e=>"submit"!==e.action),this}tab({id:e,group:t,icon:i,label:s,active:a=!1}={}){if(t??="sheet",!e&&this.#a)return this.#a=null,this;if(!e)throw new Error("You must provide an id for the tab");const n={id:e,group:t,icon:i,label:s,active:a,fields:[]};return this.#e.push(n),this.#a=n,this}fieldset({legend:e}={}){if(!e&&this.#n)return this.#n=null,this;if(!e)throw new Error("You must provide a legend for the fieldset");const t={legend:e,fieldset:!0,fields:[]};return this.#l(t),this.#n=t,this}html(e){const t={html:e};return this.#l(t),this}text({name:e,label:t,hint:i,value:s}){const a={field:new foundry.data.fields.StringField,name:e,label:t,hint:i,value:s};return this.#l(a),this}number({name:e,label:t,hint:i,value:s,min:a,max:n,step:r}){const o={field:new foundry.data.fields.NumberField,name:e,label:t,hint:i,value:s,min:a,max:n,step:r};return this.#l(o),this}checkbox({name:e,label:t,hint:i,value:s}){const a={field:new foundry.data.fields.BooleanField,name:e,label:t,hint:i,value:s};return this.#l(a),this}color({name:e,label:t,hint:i,value:s}){const a={field:new foundry.data.fields.ColorField,name:e,label:t,hint:i,value:s};return this.#l(a),this}file({name:e,type:t,label:s,hint:a,value:n}){t??="imagevideo";const r=i[t],o=new foundry.data.fields.FilePathField({categories:r});o.categories=[t];const u={field:o,name:e,label:s,hint:a,type:t,value:n};return this.#l(u),this}select({name:e,label:t,hint:i,value:s,options:a}){const n={field:inferSelectDataType(a)===Number?new foundry.data.fields.NumberField({choices:a,required:!0}):new foundry.data.fields.StringField({choices:a,required:!0,blank:!1}),name:e,label:t,hint:i,value:s??a[0]?.key,options:a};return this.#l(n),this}multiSelect({name:e,label:t,hint:i,value:s,options:a}){const n=inferSelectDataType(a)===Number?new foundry.data.fields.NumberField({choices:a,nullable:!1}):new foundry.data.fields.StringField({choices:a,nullable:!1}),r={field:new foundry.data.fields.SetField(n),name:e,label:t,hint:i,value:s,options:a};return this.#l(r),this}editor({name:e,label:t,hint:i,value:s}){const a={field:new foundry.data.fields.HTMLField,name:e,label:t,hint:i,value:s};return this.#l(a),this}textArea({name:e,label:t,hint:i,value:s}){const a={field:new foundry.data.fields.JSONField,name:e,label:t,hint:i,value:s,stacked:!0};return this.#l(a),this}script({name:e,label:t,hint:i,value:s}){const a={field:new foundry.data.fields.JavaScriptField,name:e,label:t,hint:i,value:s};return this.#l(a),this}uuid({name:e,label:t,hint:i,value:s,type:a,multiple:n}){const r={field:new foundry.data.fields.DocumentUUIDField({type:a},{}),name:e,label:t,hint:i,value:s,type:a,multiple:n};let o;return o=n?{field:new foundry.data.fields.SetField(r.field),name:e,label:t,hint:i,value:s,multiple:n}:r,this.#l(o),this}button({label:e,action:t,icon:i,callback:s}){t??=foundry.utils.randomID();const a={action:t,type:"button",icon:i,label:e,callback:s};return this.#i.push(a),this}}const i={imagevideo:["IMAGE","VIDEO"],image:["IMAGE"],video:["VIDEO"],audio:["AUDIO"],font:["FONT"],graphics:["GRAPHICS"]};function inferSelectDataType(e){const t=Array.isArray(e)?e.map(e=>e.key):Object.keys(e);try{if(t.every(e=>"number"==typeof JSON.parse(e)))return Number}catch(e){return String}return String}class FormHelper extends(foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2)){constructor(e){const t={};e.buttons.forEach(e=>t[e.action]=e.callback),super({actions:t,...e.options}),FormHelper.registerPartial(),this.menu=e.settingsMenu,this.resolve,this.reject,this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t}),this.onRenderFunction=e.options.onRender,this.#u=e.options.info,this.processFormStructure(e)}#t;#i;#u;static DEFAULT_OPTIONS={classes:["form-helper"],tag:"form",window:{contentClasses:["standard-form"]},position:{width:560,height:"auto"},form:{handler:this.#h,closeOnSubmit:!0},actions:{}};static PARTS={tabs:{template:"templates/generic/tab-navigation.hbs"},genericForm:{template:t,classes:["standard-form","scrollable"]},footer:{template:"templates/generic/form-footer.hbs"}};static registerPartial(){if(Handlebars.partials[t])return;const e=Handlebars.compile(a);Handlebars.registerPartial(t,e)}processFormStructure(e){const t=this.menu?game.settings.get(this.menu.moduleId,this.menu.key):{},i=!!this.menu;if(e.tabs?.length){this.__tabs={};e.tabs.find(e=>e.active)||(e.tabs[0].active=!0);for(const s of e.tabs)if(this.__tabs[s.id]={id:s.id,group:s.group,icon:s.icon,label:s.label,active:s.active??!1,fields:s.fields??[]},i){const e=s.fields??[];for(const i of e){const e=foundry.utils.getProperty(t,i.name);void 0!==e&&(i.value=e)}}}if(i){const i=e.fields??[];for(const e of i){const i=foundry.utils.getProperty(t,e.name);void 0!==i&&(e.value=i)}}this.#t=e.fields??[],this.#i=e.buttons??[]}_onClose(e){super._onClose(e),this.promise.resolved||this.resolve(!1)}_prepareContext(e){return{tabs:this.#d(),fields:this.#t,info:this.#u,buttons:[...this.#i.filter(e=>"submit"!==e.type),...this.#i.filter(e=>"submit"===e.type)]}}_onRender(e,t){super._onRender(e,t),this.__tabs||this.element.querySelector("nav").classList.add("hidden"),this.onRenderFunction&&this.onRenderFunction.bind(this)(e,t)}#d(){const e=this.__tabs??{};for(const t of Object.values(e))if(t.cssClass=t.active?"active":"",t.active)break;return e}changeTab(...e){super.changeTab(...e)}_onChangeForm(e,t){super._onChangeForm(e,t);new FormDataExtended(this.element)}getFormData(){const e=new FormDataExtended(this.element);return foundry.utils.expandObject(e.object)}static async#h(e,t,i){const s=foundry.utils.expandObject(i.object);if(this.resolve(s),this.menu)return this.menu.requiresReload&&SettingsConfig.reloadConfirm(),this.menu.onChange&&this.menu.onChange(s),game.settings.set(this.menu.moduleId,this.menu.key,s)}}const s="\n    {{#if field.fieldset}}\n    <fieldset>\n        <legend>{{localize field.legend}}</legend>\n        {{#each field.fields as |f|}}\n        {{#if f.html}}{{{f.html}}}{{else}}\n        {{formField f.field stacked=f.stacked type=f.type label=f.label hint=f.hint name=f.name value=f.value min=f.min max=f.max step=f.step localize=true}}\n        {{/if}}\n        {{/each}}\n    </fieldset>\n    {{else}}\n    {{#if field.html}}{{{field.html}}}{{else}}\n    {{formField field.field stacked=field.stacked multiple=field.multiple type=field.type label=field.label hint=field.hint name=field.name value=field.value min=field.min max=field.max step=field.step localize=true}}\n    {{/if}}\n    {{/if}}\n        ",a=`<div>\n    {{#if info}}{{{info}}}{{/if}}\n    {{#each tabs as |tab|}}\n\n    <section class="tab standard-form scrollable {{tab.cssClass}}" data-tab="{{tab.id}}" data-group="{{tab.group}}">\n        {{#each tab.fields as |field|}}\n        ${s}\n        {{/each}}\n    </section>\n\n    {{/each}}\n\n    {{#each fields as |field|}}\n    ${s}\n    {{/each}}\n</div>`,n="hurry-up";function parseTime(e){let t=0,i=0,s=0;const a=/^(\d+)h(\d+)m(\d+)s$|^(\d+):(\d+):(\d+)$/,n=/^(\d+)m(\d+)s$|^(\d+):(\d+)$/,r=/^(\d+)h(\d+)m$/,o=/^(\d+)h(\d+)s$/,u=/^(\d+)h$/,h=/^(\d+)m$/,d=/^(\d+)s$/;if(a.test(e)){const n=e.match(a);t=parseInt(n[1]??n[4]),i=parseInt(n[2]??n[5]),s=parseInt(n[3]??n[6])}else if(n.test(e)){const t=e.match(n);i=parseInt(t[1]??t[3]),s=parseInt(t[2]??t[4])}else if(r.test(e)){const s=e.match(r);t=parseInt(s[1]),i=parseInt(s[2])}else if(o.test(e)){const i=e.match(o);t=parseInt(i[1]),s=parseInt(i[2])}else if(u.test(e)){const i=e.match(u);t=parseInt(i[1])}else if(h.test(e)){const t=e.match(h);i=parseInt(t[1])}else{if(!d.test(e)){const t=parseInt(e);return isNaN(t)||(s=t),s}{const t=e.match(d);s=parseInt(t[1])}}return 3600*t+60*i+s}!function registerSettings(){Hooks.once("init",async function(){game.settings.register("hurry-up","timersData",{scope:"world",config:!1,type:Object,default:{},onChange:()=>{CombatTimer.updateAndSync()}}),game.settings.register("hurry-up","disable",{name:game.i18n.localize("hp.settings.disable.name"),hint:game.i18n.localize("hp.settings.disable.hint"),scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register("hurry-up","timerDuration",{name:game.i18n.localize("hp.settings.timerDuration.name"),hint:game.i18n.localize("hp.settings.timerDuration.hint"),scope:"world",config:!0,type:Number,default:300,onChange:e=>{CombatTimer.deleteTimer("hurry-up"),CombatTimer.checkAndCreateMainTimer()}}),game.settings.register("hurry-up","style",{name:game.i18n.localize("hp.settings.style.name"),hint:game.i18n.localize("hp.settings.style.hint"),scope:"client",config:!0,type:String,choices:{digits:"hp.settings.style.digits",circle:"hp.settings.style.circle",sand:"hp.settings.style.sand"},default:"digits",onChange:()=>{CombatTimer.updateAndSync()}}),game.settings.register("hurry-up","countup",{name:game.i18n.localize("hp.settings.countup.name"),hint:game.i18n.localize("hp.settings.countup.hint"),scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register("hurry-up","size",{name:game.i18n.localize("hp.settings.size.name"),hint:game.i18n.localize("hp.settings.size.hint"),scope:"client",config:!0,type:Number,range:{min:5,max:15,step:.5},default:8,onChange:e=>{document.documentElement.style.setProperty("--hurry-up-font-size",e+"em")}}),game.settings.register("hurry-up","windowless",{name:game.i18n.localize("hp.settings.windowless.name"),hint:game.i18n.localize("hp.settings.windowless.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:()=>{CombatTimer.updateAndSync()}}),game.settings.register("hurry-up","critical",{name:game.i18n.localize("hp.settings.critical.name"),hint:game.i18n.localize("hp.settings.critical.hint"),scope:"world",config:!0,type:Number,range:{min:1,max:100,step:1},default:10}),game.settings.register("hurry-up","secondsInsteadOfPercentage",{name:game.i18n.localize("hp.settings.secondsInsteadOfPercentage.name"),hint:game.i18n.localize("hp.settings.secondsInsteadOfPercentage.hint"),scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register("hurry-up","goNext",{name:game.i18n.localize("hp.settings.goNext.name"),hint:game.i18n.localize("hp.settings.goNext.hint"),scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register("hurry-up","runForNPC",{name:game.i18n.localize("hp.settings.runForNpc.name"),hint:game.i18n.localize("hp.settings.runForNpc.hint"),scope:"world",config:!0,type:Boolean,default:!1}),game.settings.register("hurry-up","critSoundPath",{name:game.i18n.localize("hp.settings.critSoundPath.name"),hint:game.i18n.localize("hp.settings.critSoundPath.hint"),scope:"world",config:!0,type:String,default:"modules/hurry-up/sounds/tick1.mp3",filePicker:"audio"}),game.settings.register("hurry-up","endSoundPath",{name:game.i18n.localize("hp.settings.endSoundPath.name"),hint:game.i18n.localize("hp.settings.endSoundPath.hint"),scope:"world",config:!0,type:String,default:"modules/hurry-up/sounds/Ping1.mp3",filePicker:"audio"}),game.settings.register("hurry-up","soundVol",{name:game.i18n.localize("hp.settings.soundVol.name"),hint:game.i18n.localize("hp.settings.soundVol.hint"),scope:"world",config:!0,type:Number,range:{min:0,max:1,step:.05},default:.8})})}(),Hooks.once("init",()=>{Socket.register("StartTimer",CombatTimer.socketTimer),globalThis.CombatTimer=CombatTimer}),Hooks.on("ready",async()=>{game.user.isGM&&await CombatTimer.unFuckSetting(),CombatTimer.updateAndSync()}),Hooks.on("updateCombat",(e,t)=>{if(game.user.isActiveGM)return game.combat?.started?void(("turn"in t||"round"in t)&&CombatTimer.checkAndCreateMainTimer()):CombatTimer.deleteTimer("hurry-up")}),Hooks.on("deleteCombat",(e,t)=>{game.user.isActiveGM&&CombatTimer.deleteTimer("hurry-up")}),Hooks.on("pauseGame",async e=>{if(game.user.isActiveGM)for(const t of Object.values(CombatTimer.timerInstances))await CombatTimer.setPause(t.options.id,e,!1)}),Hooks.on("chatMessage",(e,t,i)=>{if(!game.user.isGM)return!0;const s=t.match(/^\/(?:hurry|timer)(\?)?(?:\s+((?:\d+[:hms]?)+))?/i);if(s){const e=!!s[1],t=s[2]?parseTime(s[2].trim()):void 0;if(s[2])return CombatTimer.createTimer(t,{paused:e}),!1;const i=game.settings.get("hurry-up","style"),a=game.settings.settings.get("hurry-up.style").choices;return(new FormBuilder).title("hp.create.title").checkbox({name:"paused",label:"hp.create.paused",value:e}).number({name:"time",label:"hp.create.time",value:t??game.settings.get("hurry-up","timerDuration")}).text({name:"name",label:"hp.create.name",value:name}).color({name:"color",label:"hp.create.color",value:""}).select({name:"timerStyle",label:"hp.settings.style.name",value:i,options:a}).render().then(e=>{if(e)return!e.time||e.time<=0?ui.notifications.error("hp.create.timeError"):void CombatTimer.createTimer(parseTime(e.time),{name:e.name,paused:!!e.paused,color:e.color,style:e.timerStyle})}),!1}return!0})})();
//# sourceMappingURL=index.js.map